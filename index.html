<!doctype html>
<html lang="en">
<head>
    <title>Eclectic Flowers</title>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display&display=swap" rel="stylesheet">
    <style>
        /*
            colors: #F1A7F1 #FAD0C4 #CAA9C2 #C496A9 #414E88
        */
        * {
            box-sizing: border-box;
        }
        html {
            background-color: #fad0c4;
            background-image: linear-gradient(315deg, #fad0c4 0%, #f1a7f1 74%);
            font-family: 'Playfair Display', serif;
        }
        html,
        body {
            margin: 0;
            padding: 0 1rem;
        }
        a {
            color: #414E88;
            text-decoration: none;
        }
        h1 {
            font-weight: normal;
            font-size: 60px;
            margin: 1rem 0;
            color: #333;
        }
        .container {
            max-width: 1024px;
            margin: 0 auto;
            height: 100vh;
        }
        .products {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .products a {
            width: 33.33%;
            overflow: hidden;
            transition: opacity 0.1s ease-in-out;
            padding: 1rem;
            opacity: 0.6;
        }
        .products a:hover {
            opacity: 0.5;
        }
        .products img {
            max-width: 100%;
            display: block;
            width: 100%;
            border-radius: 10px;
        }
        p {
            line-height: 1.55;
            max-width: 700px;
            margin: 2rem auto;
            font-size: 20px;
        }
        /* kindly-chat overrides */
        /*.chat-container {*/
        /*    z-index: 9999999;*/
        /*}*/
    </style>
</head>
<body>
    <div class="container">
        <h1>Eclectic Flowers</h1>
        <div class="products">
            <a href="#">
                <img src="./img/chrysanthemum-202483_640.jpg" alt="flowers"/>
            </a>
            <a href="#">
                <img src="./img/tulips-3339416_640.jpg" alt="flowers"/>
            </a>
            <a href="#">
                <img src="./img/hydrangea-3659614_640.jpg" alt="flowers"/>
            </a>
        </div>
        <div>
            <p>
                <a href="about.html">About Eclectic Flowers</a>.<br><br>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean finibus consequat lacus eget luctus. Nam in ultricies ex. Integer sagittis bibendum enim, vitae congue tellus. Nullam justo augue, aliquet vel elementum nec, bibendum maximus arcu. Phasellus sit amet imperdiet eros. Vestibulum eleifend egestas odio posuere consequat. Fusce cursus congue augue, ac luctus massa. Maecenas et ipsum erat. Morbi ultrices eros at pellentesque dignissim. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Aenean ac odio sed urna finibus volutpat.</p>
        </div>
    </div>

    <script>
      /* Format chat log */
      function formatChat(messages) {
        const firstMessage = messages[0];
        const lastMessage = messages.slice(-1)[0];
        const header = `Bot chat history [id: ${firstMessage.chat_id}]:\n` +
          `First message: ${firstMessage.created.slice(0, -8).replace('T', ' ')}\n` +
          `Last message: ${lastMessage.created.slice(0, -8).replace('T', ' ')}\n` +
          `Users language: ${firstMessage.chat_language_code}\n`;

        const formattedMessages = messages
          .map((msg) => {
            const buttons = (msg.buttons || []).map((btn) => {
              const uri = btn.button_type === 'link' ? btn.value : `#${btn.value}`;
              return `${btn.label}[${uri}]`;
            });
            let hourAndMinute = msg.created.slice(11, -8).replace('T', ' ');
            return `${hourAndMinute} ${msg.from_bot ? 'Bot' : 'You'}: ${msg.message}\n${buttons.length ? `Buttons: ${buttons.join(' ')}\n` : ''}`;
          })
          .join('\n');

        return `${header}\n${formattedMessages}`;
      }
      /* Zendesk Chat Widget settings */
      window.zESettings = {
        webWidget: {
          color: { theme: '#f1a7f1' },
          // offset: {
          //   horizontal: '80px',
          //   vertical: '10px'
          // },
          // zIndex: 999  // kindly-chat is @ z-index: 1000
        }
      };

      // Check if manual chat has been started
      window.startedManualChat = localStorage.getItem('startedManualChat') === 'true';

      /* Kindly Chat settings */
      window.kindlyOptions = {
        bubbleHidden: startedManualChat,  // FIXME: does this work?
        buttonHandlers: {
          /* On takeover click open zendesk bubble */
          takeover_request: (e, button, chatMessage, chatMessages) => {
            const displayState = zE('webWidget:get', 'display');
            window.kindlyChat.closeChat();
            window.kindlyChat.hideBubble();

            console.log(displayState)
            if (displayState !== 'chat') {  // Do nothing if chat is already open
              localStorage.setItem('startedManualChat', "true");
              window.startedManualChat = true;
              zE('webWidget', 'show');
              zE('webWidget', 'open');

              // Only send manual chat if already started
              if(!window.startedManualChat) {
                zE('webWidget', 'chat:send', formatChat(chatMessages));
              }
            }
            return true;  // true means preventDefault for kindly-chat specific default behaviour
          }
        }
      }
    </script>
    <script id="kindly-chat" src="https://chat-dev.kindlycdn.com/kindly-chat.js?yo=lo" data-bot-key="99de928b-898d-4f6c-a216-1098eb1154f7" async></script>
    <script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key=ce3e09dc-df8e-4c48-bf3a-46a0c28a1bbc"></script>
    <script>
      // References:
      // - https://developer.zendesk.com/embeddables/docs/widget/core
      // - https://developer.zendesk.com/embeddables/docs/widget/chat
      // - https://develop.zendesk.com/hc/en-us/articles/360025618474-Quickstart-Web-Widget-JavaScript-APIs

      if(!window.startedManualChat) {
        /* Hidden by default, show if started manual chat at least once */
        zE('webWidget', 'hide');
      }

      // show bot again if manual chat has ended
      zE('webWidget:on', 'chat:end', () => {
        // TODO: this triggers on page refresh, why?
        console.log('chat ended');
        const displayState = zE('webWidget:get', 'display');
        console.log('displayState', displayState)
        // localStorage.removeItem('startedManualChat');
        // zE('webWidget', 'hide');
        window.kindlyChat.showBubble();
      });
    </script>
</body>
</html>
